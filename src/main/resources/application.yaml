# -------------------------------------------------------------------------------------
# Server & Spring Boot
# -------------------------------------------------------------------------------------
server:
  # Uncomment to serve FHIR under a non-default context path (e.g., /example/path/fhir)
  # servlet:
  #   context-path: /example/path
  port: 8080
  tomcat:
    # allow | as a separator in URLs
    relaxed-query-chars: "|"

# -------------------------------------------------------------------------------
# Logging Configuration
# -------------------------------------------------------------------------------
logging:
  level:
    # Suppress HAPI-1220 retry errors during search parameter cache warmup
    # These errors are cosmetic and non-critical (see PARTITION_CONFIGURATION_FINAL.md)
    ca.uhn.fhir.jpa.searchparam.retry.Retrier: OFF

management:
  # Actuator endpoints: only /actuator/health exposed by default
  endpoints:
    enabled-by-default: false
    web:
      exposure:
        include: "health"  # or "info,health,prometheus,metrics" or "*" for all
  endpoint:
    info:
      enabled: true
    metrics:
      enabled: true
    health:
      enabled: true
      probes:
        enabled: true
      group:
        liveness:
          include: [ "livenessState", "readinessState" ]
    prometheus:
      enabled: true
  prometheus:
    metrics:
      export:
        enabled: true

spring:
  # -------------------------------------------------------------------------------
  # A. Spring AI — Model Context Protocol (MCP)
  # -------------------------------------------------------------------------------
  ai:
    mcp:
      server:
        name: FHIR MCP Server
        version: 1.0.0
        instructions: "This server provides access to a FHIR RESTful API. You can use it to query FHIR resources, perform operations, and retrieve data in a structured format."
        enabled: true
        streamable-http:
          mcp-endpoint: /mcp/messages

  # -------------------------------------------------------------------------------
  # B. Core Spring
  # -------------------------------------------------------------------------------
  main:
    allow-bean-definition-overriding: false
    allow-circular-references: true

  autoconfigure:
    # This exclude is only needed for setups not using Elasticsearch where the elasticsearch sniff is not needed.
    exclude: org.springframework.boot.autoconfigure.elasticsearch.ElasticsearchRestClientAutoConfiguration

  flyway:
    enabled: false
    baseline-on-migrate: true
    fail-on-missing-locations: false

  # -------------------------------------------------------------------------------
  # PostgreSQL Configuration for Local Installation
  # -------------------------------------------------------------------------------
  datasource:
    url: jdbc:postgresql://localhost:5432/ddx_hapifhir
    username: dudoxx_user
    password: admin
    driver-class-name: org.postgresql.Driver
    hikari:
      # Connection Pool Configuration
      maximum-pool-size: 10
      minimum-idle: 5
      connection-timeout: 30000           # 30 seconds
      idle-timeout: 600000                # 10 minutes
      max-lifetime: 1800000               # 30 minutes
      auto-commit: true
      pool-name: HapiFhirHikariPool
      # Connection Test Query
      connection-test-query: SELECT 1
      # Logging
      register-mbeans: true
      # Transaction Isolation
      transaction-isolation: TRANSACTION_READ_COMMITTED

  jpa:
    open-in-view: false                          # Disable open session in view (not needed for API)
    properties:
      hibernate:
        format_sql: false
        show_sql: false
        # IMPORTANT: Use HapiFhirPostgresDialect for PostgreSQL
        dialect: ca.uhn.fhir.jpa.model.dialect.HapiFhirPostgresDialect
        hbm2ddl:
          auto: update
        jdbc:
          batch_size: 20
        cache:
          use_query_cache: false
          use_second_level_cache: false
          use_structured_entries: false
          use_minimal_puts: false

        # --- Hibernate Search (Lucene/Elasticsearch) ---
        search:
          enabled: false

# -------------------------------------------------------------------------------------
# HAPI FHIR — grouped by domain
# -------------------------------------------------------------------------------------
hapi:
  fhir:

    # -------------------------------------------------------------------------------
    # A. Core Server & API
    # -------------------------------------------------------------------------------
    openapi_enabled: true                       # Swagger UI at /fhir/swagger-ui/index.html; API docs at /fhir/api-docs
    fhir_version: R4                            # DSTU2 | DSTU3 | R4 | R5
    
    # -------------------------------------------------------------------------------
    # Custom Bean Packages (REQUIRED for ClinicPartitionInterceptor)
    # -------------------------------------------------------------------------------
    custom_bean_packages: ca.uhn.fhir.jpa.starter.interceptor
    
    # -------------------------------------------------------------------------------
    # Authentication & Authorization
    # -------------------------------------------------------------------------------
    auth:
      enabled: true                             # Set to true to enable API token authentication
      api_token: ddx-api-token-2024            # API token for Bearer authentication
      # For OAuth 2.0, configure external OAuth provider (Keycloak, Auth0, etc.)
    server_address: http://localhost:8080/fhir  # Server base URL

    # -------------------------------------------------------------------------------
    # B. Implementation Guides (IG) & Package Install
    # -------------------------------------------------------------------------------
    ig_runtime_upload_enabled: false

    # -------------------------------------------------------------------------------
    # C. Clinical Reasoning / CQL / Care Gaps / CDS Hooks
    # -------------------------------------------------------------------------------
    cr:
      enabled: false                            # exposes Clinical Reasoning operation endpoints
      caregaps:
        reporter: "default"
        section_author: "default"
      terminologyServerClientSettings:
        maxRetryCount: 3
        retryIntervalMillis: 1000
        timeoutSeconds: 30
        socketTimeout: 60
      cql:
        use_embedded_libraries: true
        compiler:
          error_level: Info
          signature_level: All
          enable_annotations: true
          enable_locators: true
          enable_results_type: true
          enable_detailed_errors: true
        runtime:
          debug_logging_enabled: false
      terminology:
        valueset_preexpansion_mode: REQUIRE            # USE_IF_PRESENT | REQUIRE | IGNORE
        valueset_expansion_mode: PERFORM_NAIVE_EXPANSION   # AUTO | USE_EXPANSION_OPERATION | PERFORM_NAIVE_EXPANSION
        valueset_membership_mode: USE_EXPANSION            # AUTO | USE_VALIDATE_CODE_OPERATION | USE_EXPANSION
        code_lookup_mode: USE_VALIDATE_CODE_OPERATION      # AUTO | USE_VALIDATE_CODE_OPERATION | USE_CODESYSTEM_URL
      data:
        search_parameter_mode: USE_SEARCH_PARAMETERS       # AUTO | USE_SEARCH_PARAMETERS | FILTER_IN_MEMORY
        terminology_parameter_mode: FILTER_IN_MEMORY       # AUTO | USE_VALUE_SET_URL | USE_INLINE_CODES | FILTER_IN_MEMORY
        profile_mode: DECLARED                             # ENFORCED | DECLARED | OPTIONAL | TRUST | OFF
    cdshooks:
      enabled: false
      clientIdHeaderName: client_id

    # -------------------------------------------------------------------------------
    # D. Search & Indexing
    # -------------------------------------------------------------------------------
    advanced_lucene_indexing: false
    search_index_full_text_enabled: false

    # -------------------------------------------------------------------------------
    # E. Bulk Operations
    # -------------------------------------------------------------------------------
    bulk_export_enabled: true
    bulk_import_enabled: true

    # -------------------------------------------------------------------------------
    # F. Write / Delete / Integrity
    # -------------------------------------------------------------------------------
    allow_cascading_deletes: true
    allow_contains_searches: true
    allow_external_references: true
    allow_multiple_delete: true
    allow_override_default_search_params: true
    enforce_referential_integrity_on_delete: false
    enforce_referential_integrity_on_write: false
    etag_support_enabled: true
    expunge_enabled: true

    # -------------------------------------------------------------------------------
    # G. Narrative & Validation
    # -------------------------------------------------------------------------------
    narrative_enabled: true
    validation:
      requests_enabled: false
      responses_enabled: false

    # -------------------------------------------------------------------------------
    # H. MDM (Master Data Management)
    # -------------------------------------------------------------------------------
    mdm_enabled: false
    mdm_rules_json_location: "mdm-rules.json"

    # -------------------------------------------------------------------------------
    # I. Terminology / ValueSet Expansion
    # -------------------------------------------------------------------------------
    logical_urls:
      - http://terminology.hl7.org/*
      - https://terminology.hl7.org/*
      - http://snomed.info/*
      - https://snomed.info/*
      - http://unitsofmeasure.org/*
      - https://unitsofmeasure.org/*
      - http://loinc.org/*
      - https://loinc.org/*

    # -------------------------------------------------------------------------------
    # J. CORS
    # -------------------------------------------------------------------------------
    cors:
      allow_Credentials: true
      allowed_origin:
        - "*"

    # -------------------------------------------------------------------------------
    # K. Search Orchestration
    # -------------------------------------------------------------------------------
    search-coord-core-pool-size: 20
    search-coord-max-pool-size: 100
    search-coord-queue-capacity: 200
    search_prefetch_thresholds: 13,503,2003,-1

    # -------------------------------------------------------------------------------
    # L. Storage / Pagination / Caching
    # -------------------------------------------------------------------------------
    max_page_size: 200
    retain_cached_searches_mins: 60
    reuse_cached_search_results_millis: 60000
    binary_storage_enabled: true
    inline_resource_storage_below_size: 4000

    # -------------------------------------------------------------------------------
    # M. Subscriptions
    # -------------------------------------------------------------------------------
    # CRITICAL: Disable subscriptions to prevent partition cache warmup errors
    # The subscription cache tries to search all partitions during startup,
    # which conflicts with partition isolation. Enable only if using subscriptions.
    subscription:
      resthook_enabled: false  # Disabled to prevent HAPI-1220 errors
      websocket_enabled: false

    # -------------------------------------------------------------------------------
    # N. Multi-Tenancy / Partitioning Configuration
    # -------------------------------------------------------------------------------
    # Enable partitioning for multi-clinic isolation
    partitioning:
      # Enable partitioning mode
      enabled: true
      # Use custom ClinicPartitionInterceptor (not request tenant mode)
      request_tenant_partitioning_mode: false
      # Allow system operations to work across partitions
      allow_references_across_partitions: true
      # Include partition in search hashes for better performance
      partitioning_include_in_search_hashes: true
      # Allow conditional creates with duplicate identifiers across partitions
      conditional_create_duplicate_identifiers_enabled: true
      # Default partition ID (0 = system/default partition for background jobs)
      default_partition_id: 0
